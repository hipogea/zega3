<?phpclass Directoriofotos   extends CApplicationComponent {private $_codocu=null;private $_id=null;private $_numerofotosporcarpeta=null;private $_ruta=null;private $_rutabas=null;private $_carpetadestino=null;private $_extensionatrabajar=null;public function __construct($vcodocu=null,$vid=null,$vnumfotos=null,$vrutabas=null,$vextension) {     $this->_codocu=$vcodocu;         $this->_ruta=$vrutabas;                 IF(substr($vextension,0,1)=='.')                         $vextension=  substr ($vextension,1);         $this->_extensionatrabajar=$vextension;          $this->_id= $vid;           $this->_numerofotosporcarpeta=  $vnumfotos;                   $this->_rutabas=Yii::getPathOfAlias('webroot').$this->_ruta;                   $this->_carpetadestino= $this->_rutabas.DIRECTORY_SEPARATOR.$this->_codocu.DIRECTORY_SEPARATOR.$this->_extensionatrabajar.DIRECTORY_SEPARATOR.trim((string)ceil($this->_id/$this->_numerofotosporcarpeta)).DIRECTORY_SEPARATOR;                   $this->creacarpeta();                   }        //Define     private function existecarpetabase(){                if (is_dir($this->_rutabas)) {               return  true;                           } else {               return false;                }           }        private function existecarpetadocu(){                if (is_dir($this->_rutabas.DIRECTORY_SEPARATOR.$this->_codocu)) {               return  true;                           } else {               return false;                }           }        private function existecarpetaextension(){                if (is_dir($this->_rutabas.DIRECTORY_SEPARATOR.$this->_codocu.DIRECTORY_SEPARATOR.$this->_extensionatrabajar)) {               return  true;                           } else {               return false;                }           }        public function creacarpetabase(){             //$filename=Yii::getPathOfAlias('webroot').$this->_ruta;        if($this->existecarpetabase()){            return true;        }else{              if(mkdir($this->_rutabas, 0777)){                  return true;              }else{                  return false;              }                        }    }            public function creacarpeta(){       //var_dump($ruta);die();       ///primero verificando sio exisgte la carpeta raiz         $nombrec= trim((string)ceil($this->_id/$this->_numerofotosporcarpeta)).DIRECTORY_SEPARATOR;       if($this->existecarpetabase()){                        if($this->existecarpetadocu()){                                     if($this->existecarpetaextension()){                                                  if (is_dir($this->_rutabas.DIRECTORY_SEPARATOR.$this->_codocu.DIRECTORY_SEPARATOR.$this->_extensionatrabajar.DIRECTORY_SEPARATOR.$nombrec))                                                                                                {                                                                                                         return true;                                                                                                }else{                                                                                                             if(mkdir($this->_carpetadestino,0777)){                                                                                                                     $this->creacarpeta();                                                                                                               }else{                                                                                                                    return false;                                                                                                                }                                                                                                     }                                                                                                                                                                                                                }else{                                                    if(mkdir($this->_rutabas.DIRECTORY_SEPARATOR.$this->_codocu, 0777)){                                                                                     $this->creacarpeta();                  //$this->_carpetadestino=$ruta.DIRECTORY_SEPARATOR;                                                                                                 }else{                                                                                                            return false;                                                                                                    }                                                   }                                    } else {                                         if(mkdir($this->_rutabas, 0777)){                                                                     $this->creacarpeta();                 // $this->_carpetadestino=$ruta.DIRECTORY_SEPARATOR;                                                             }else{                                                                return false;                                                                    }                                                                                                                    }              }                          }        public function colocaarchivo($filename) {        if(strtolower(trim($this->extension($filename)))==strtolower(trim($this->_extensionatrabajar)))           {           // $this->creacarpeta();          IF (is_file($filename)) {             // var_dump($filename);die();              $nombrec= trim((string)ceil($this->_id/$this->_numerofotosporcarpeta)).DIRECTORY_SEPARATOR;       $ruta=$this->_rutabas.DIRECTORY_SEPARATOR.$this->_codocu.DIRECTORY_SEPARATOR.$this->_extensionatrabajar.DIRECTORY_SEPARATOR.$nombrec;                    if(copy($filename,$ruta.$this->colocanombre())){                 return true;             }else{                 return false;             }          }else{              return false;          }       }else{            throw new CHttpException(500,__CLASS__.'  '.__FUNCTION__.'    => La extension del archivo '.$filename.' no coincide con las extension "'.$this->_extensionatrabajar.'"');			        }    }        private function extension($nombrearchivo){        return strtolower(trim(strrev(substr(strrev($nombrearchivo),0,3))));    }        private function colocanombre(){                   return $this->_id."_".((microtime(true))*10000)."_".yii::app()->user->id.".".$this->_extensionatrabajar;                  }        public function recuperaarchivos($rutasabsolutas){        $archivos= CFileHelper::findFiles(                $this->_carpetadestino,               array('fileTypes'=>array($this->_extensionatrabajar),		'exclude'=>array(),                'level'=>0,                'absolutePaths'=>$rutasabsolutas,                ));        $archivosfiltrados=array();        foreach($archivos as $clave=>$nombre)            {            //var_dump(strpos($nombre,$this->_id.'_'));                                              if(strpos($nombre,$this->_id.'_')>=0){                            /* echo " nombre en la cadena ";                             var_dump(substr($nombre,strpos($nombre,$this->_id.'_'),strlen(trim($this->_id))));                             echo "<br>";                                                                                     echo " nombre en el id ";                             var_dump(trim($this->_id));                                                          echo "<br>";                              echo "Comparacion <br>";                              var_dump(substr($nombre,strpos($nombre,$this->_id.'_'),strlen(trim($this->_id)))===trim($this->_id));                              echo "<br>";*/                                                          if(substr($nombre,strpos($nombre,$this->_id.'_'),strlen(trim($this->_id)))===trim($this->_id))                             //$archivosfiltrados[]=substr($nombre,strpos($nombre,$this->_id.'_'),strlen(trim($this->_id)));                                     if($rutasabsolutas){                                         $archivosfiltrados[]=$this->_carpetadestino.substr($nombre,strpos($nombre,$this->_id.'_'));                                     }else{                                         $archivosfiltrados[]=$nombre;                                     }                                                              }                                                                            }                return $archivosfiltrados;            }        public function borraarchivos(){        foreach($this->recuperaarchivos(true) as $archivo ){            unlink($archivo);        }                            }        public function borraarchivo($nombrecorto){        unlink($this->_carpetadestino.$nombrecorto);        }        public function getcreado($nombrecorto){        $aparts=explode("_",$nombrecorto);                return date("Y-m-d H:i:s",$aparts[1]/10000);    }    public function getquiensubio($nombrecorto){        $aparts=explode("_",$nombrecorto);                return strrev(substr(strrev($aparts[2]),4));    }        public function getauditoria(){        $audi=array();                foreach($this->recuperaarchivos(false) as $clave=>$nombre){            $nombrearch=substr($nombre,strpos($nombre,$this->_id.'_'));            $audi[$nombrearch]['nombre']=$nombrearch;            $audi[$nombrearch]['creado']=$this->getcreado($nombrearch);             $audi[$nombrearch]['subidopor']=$this->getquiensubio($nombrearch);        }        return $audi;    }       }?>